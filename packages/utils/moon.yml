$schema: "../../.moon/cache/schemas/project.json"

type: "library"
language: "other"

project:
  name: "Proto Utils"
  description: "Shared protobuf utilities and generated code"

tasks:
  python-sync:
    command: "uv"
    args:
      - "--project"
      - "./python/pyproject.toml"
      - "sync"
    outputs:
      - "./python/.venv/"
    options:
      runFromWorkspaceRoot: false

  python-build:
    command: "bash ./scripts/python-build.sh"
    outputs:
      - "./python/dist/"
      - "./python/build/"
      - "./python/proto_utils.egg-info/"
    options:
      runFromWorkspaceRoot: false

  python-generate-database:
    deps:
      - "^:python-sync"
    command: "uv"
    args:
      - "--project"
      - "./python/pyproject.toml"
      - "run"
      - "python"
      - "-m"
      - "grpc_tools.protoc"
      - "--pyi_out=./python/proto_utils/generated/"
      - "--python_out=./python/proto_utils/generated/"
      - "--grpc_python_out=./python/proto_utils/generated/"
      - "--proto_path=../proto/"
      - "database/database.proto"
      - "database/mongo.proto"
      - "database/redis.proto"
      - "database/utils.proto"
      - "parsers/ddl_generator.proto"
      - "parsers/dtypes.proto"
      - "parsers/formula_parser.proto"
      - "parsers/sql_builder.proto"
      - "messaging/messaging.proto"
    outputs:
      - "./python/proto_utils/generated/database"
    options:
      runFromWorkspaceRoot: false

  python-generate-parsers:
    deps:
      - "^:python-sync"
    command: "uv"
    args:
      - "--project"
      - "./python/pyproject.toml"
      - "run"
      - "python"
      - "-m"
      - "grpc_tools.protoc"
      - "--pyi_out=./python/proto_utils/generated/"
      - "--python_out=./python/proto_utils/generated/"
      - "--grpc_python_out=./python/proto_utils/generated/"
      - "--proto_path=../proto/"
      - "parsers/ddl_generator.proto"
      - "parsers/dtypes.proto"
      - "parsers/formula_parser.proto"
      - "parsers/sql_builder.proto"
    outputs:
      - "./python/proto_utils/generated/parsers"
    options:
      runFromWorkspaceRoot: false
