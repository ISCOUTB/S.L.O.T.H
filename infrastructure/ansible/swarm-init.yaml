---
- name: Initialize Docker Swarm on Manager
  hosts: managers[0]
  remote_user: ubuntu
  become: yes
  gather_facts: yes
  tasks:
  - name: Get manager private IP
    set_fact:
      manager_private_ip: "{{ hostvars[inventory_hostname]['private_ip'] }}"

  - name: Initialize Docker Swarm
    shell: docker swarm init --advertise-addr {{ manager_private_ip }}
    register: swarm_init_output
    ignore_errors: yes

  - name: Generate manager token
    shell: docker swarm join-token manager -q
    register: manager_token
    changed_when: false

  - name: Generate worker token
    shell: docker swarm join-token worker -q
    register: worker_token
    changed_when: false

  - name: Save tokens to local files
    delegate_to: localhost
    become: no
    copy:
      content: "{{ item.content }}"
      dest: "{{ item.dest }}"
    with_items:
    - content: "{{ manager_token.stdout }}"
      dest: "./manager-token.txt"
    - content: "{{ worker_token.stdout }}"
      dest: "./worker-token.txt"

  - name: Display swarm info
    shell: docker node ls
    register: swarm_info

  - name: Print swarm status
    debug:
      msg: "{{ swarm_info.stdout_lines }}"

- name: Join Additional Managers to Swarm
  hosts: managers[1:]
  remote_user: ubuntu
  become: yes
  serial: 1
  tasks:
  - name: Read manager token
    set_fact:
      manager_token: "{{ lookup('file', './manager-token.txt') }}"
      manager_private_ip: "{{ hostvars[groups['managers'][0]]['private_ip'] }}"

  - name: Join manager to swarm
    shell: "docker swarm join --token {{ manager_token }} {{ manager_private_ip }}:2377"
    register: join_output
    ignore_errors: yes

  - name: Display join output
    debug:
      msg: "{{ join_output.stdout }}"

- name: Join Workers to Swarm
  hosts: workers
  remote_user: ubuntu
  become: yes
  serial: 1
  tasks:
  - name: Read worker token
    set_fact:
      worker_token: "{{ lookup('file', './worker-token.txt') }}"
      manager_private_ip: "{{ hostvars[groups['managers'][0]]['private_ip'] }}"

  - name: Join worker to swarm
    shell: "docker swarm join --token {{ worker_token }} {{ manager_private_ip }}:2377"
    register: join_output
    ignore_errors: yes

  - name: Display join output
    debug:
      msg: "{{ join_output.stdout }}"

- name: Verify Swarm Cluster
  hosts: managers[0]
  remote_user: ubuntu
  become: yes
  tasks:
  - name: List all nodes
    shell: docker node ls
    register: cluster_status

  - name: Print cluster status
    debug:
      msg: "{{ cluster_status.stdout_lines }}"
