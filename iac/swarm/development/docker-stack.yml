# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

services:
    prometheus:
        image: prom/prometheus:latest
        volumes:
            - prometheus-data:/prometheus
            - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=3d"
        networks:
            - monitoring
        ports:
            - 9090:9090
        deploy:
            placement:
                constraints:
                    - node.role == manager
            resources:
                limits:
                    memory: 512M

    cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        hostname: "{{.Node.Hostname}}"
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker:/var/lib/docker:ro
        networks:
            - monitoring
        ports:
            - 8080:8080
        deploy:
            mode: global
            labels:
                - prometheus-job=cadvisor
            resources:
                limits:
                    memory: 128M

    node-exporter:
        image: prom/node-exporter:latest
        volumes:
            - /:/rootfs:ro
            - /sys:/host/sys:ro
            - /proc:/host/proc:ro
        command:
            - "--path.procfs=/host/proc"
            - "--path.sysfs=/host/sys"
            - "--path.rootfs=/rootfs"
        networks:
            - monitoring
        ports:
            - 9100:9100
        deploy:
            mode: global

networks:
    monitoring:

volumes:
    prometheus-data:
