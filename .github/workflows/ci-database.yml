name: CI - Database Tests
on:
  pull_request:
    branches:
      - main
      - staging
      - feat/CI # Temporal
    paths:
      - "apps/connections/database/**"
      - "packages/messaging-utils/messaging-utils-py/**"
      - "packages/proto-utils/proto-utils-py/**"

env:
  ENV_EXAMPLE_FILE: "apps/connections/database/.env.example"

jobs:
  setup-databases:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin

      redis:
        image: bitnami/redis:latest
        ports:
          - 6379:6379
        env:
          REDIS_PASSWORD: admin

    steps:
      - uses: actions/checkout@v4
      - run: pwd  # Debugging step to print the current directory
      - run: ls -la apps/connections/database/  # Debugging step to list

      - name: Update .env.example with CI values
        run: |
          # Verify that the .env.example file exists
          if [[ ! -f "$ENV_EXAMPLE_FILE" ]]; then
            ENV_DIR=$(dirname "$ENV_EXAMPLE_FILE")
            echo "Error: $ENV_EXAMPLE_FILE does not exist"
            echo "Available files in ${ENV_DIR}/:"
            ls -la "${ENV_DIR}/" || echo "Directory does not exist"
            exit 1
          fi

          # Backup the original .env.example file
          cp "$ENV_EXAMPLE_FILE" "$ENV_EXAMPLE_FILE.backup"

          # Update values for CI environment using sed with validation
          sed -i 's/^MONGO_HOST=.*/MONGO_HOST=localhost/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^REDIS_HOST=.*/REDIS_HOST=localhost/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^MONGO_INITDB_ROOT_USERNAME=.*/MONGO_INITDB_ROOT_USERNAME=admin/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^MONGO_INITDB_ROOT_PASSWORD=.*/MONGO_INITDB_ROOT_PASSWORD=admin/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^REDIS_PASSWORD=.*/REDIS_PASSWORD=admin/' "$ENV_EXAMPLE_FILE"

          # Validate modifications were successful
          echo "Validating modifications..."
          grep -q "MONGO_HOST=localhost" "$ENV_EXAMPLE_FILE" || echo "Warning: MONGO_HOST not updated"
          grep -q "REDIS_HOST=localhost" "$ENV_EXAMPLE_FILE" || echo "Warning: REDIS_HOST not updated"

          echo "Updated .env.example for CI:"
          cat "$ENV_EXAMPLE_FILE"

      # - name: Upload modified .env.example
      #   run: |
      #     # Get the absolute path of the directory containing the target file/directory
      #     abs_dir="$(cd "$(dirname "$ENV_EXAMPLE_FILE")" && pwd -P)"

      #     # Get the basename of the target file/directory
      #     basename="$(basename "$ENV_EXAMPLE_FILE")"

      #     # Construct the full absolute path
      #     file_path="$abs_dir/$basename"

      #     # Save the file path to an environment variable for later steps
      #     echo "UPLOAD_PATH=$file_path" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: env-file-modified
          path: ./apps/connections/database/.env.example
          retention-days: 1
          if-no-files-found: error

  database-tests:
    uses: ./.github/workflows/reusable-ci-tests.yml
    needs: setup-databases
    with:
      service_name: "database"
      env_example_file: "apps/connections/database/.env.example"
      artifact_name: "env-file-modified"
