name: CI - Database Tests
on:
  pull_request:
    branches:
      - main
      - staging
    paths:
      - "apps/connections/database/**"
      - "packages/messaging-utils/messaging-utils-py/**"
      - "packages/proto-utils/proto-utils-py/**"

env:
  ENV_EXAMPLE_FILE: "apps/connections/database/.env.example"

jobs:
  setup-databases:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin

      redis:
        image: bitnami/redis:latest
        ports:
          - 6379:6379
        env:
          REDIS_PASSWORD: admin

    steps:
      - uses: actions/checkout@v4
      - name: Update .env.example with CI values
        run: |
          # Verify that the .env.example file exists
          if [[ ! -f "$ENV_EXAMPLE_FILE" ]]; then
            ENV_DIR=$(dirname "$ENV_EXAMPLE_FILE")
            echo "Error: $ENV_EXAMPLE_FILE does not exist"
            echo "Available files in ${ENV_DIR}/:"
            ls -la ${ENV_DIR}/ || echo "Directory does not exist"
            exit 1
          fi

          # Backup the original .env.example file
          cp "$ENV_EXAMPLE_FILE" "$ENV_EXAMPLE_FILE.backup"

          # Update values for CI environment using sed
          sed -i 's/^MONGO_HOST=.*/MONGO_HOST=localhost/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^REDIS_HOST=.*/REDIS_HOST=localhost/' "$ENV_EXAMPLE_FILE"

          # Ensure CI-specific values are set
          sed -i 's/^MONGO_INITDB_ROOT_USERNAME=.*/MONGO_INITDB_ROOT_USERNAME=admin/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^MONGO_INITDB_ROOT_PASSWORD=.*/MONGO_INITDB_ROOT_PASSWORD=admin/' "$ENV_EXAMPLE_FILE"
          sed -i 's/^REDIS_PASSWORD=.*/REDIS_PASSWORD=admin/' "$ENV_EXAMPLE_FILE"

          echo "Updated .env.example for CI:"
          cat "$ENV_EXAMPLE_FILE"

          # Verify the file exists after modifications
          echo "File exists after modifications: $(ls -la "$ENV_EXAMPLE_FILE")"

      - name: Upload modified .env.example
        uses: actions/upload-artifact@v4
        with:
          name: env-file-modified
          path: ${{ github.workspace }}/${{ env.ENV_EXAMPLE_FILE}}
          retention-days: 1
          if-no-files-found: error
  database-tests:
    uses: ./.github/workflows/reusable-ci-tests.yml
    needs: setup-databases
    with:
      service_name: "database"
      env_example_file: "${{ env.ENV_EXAMPLE_FILE }}"
      artifact_name: "env-file-modified"
